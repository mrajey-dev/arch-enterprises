<?php
use App\Http\Controllers\MailController;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\Api\AuthController;
use App\Http\Controllers\UserController;
use App\Http\Controllers\LeaveTypeController;
use App\Http\Controllers\Api\DepartmentController;
use App\Http\Controllers\Api\DailyReportController;
use App\Http\Controllers\TaskController;
use App\Http\Controllers\Api\TaskReportController;
use App\Http\Controllers\Api\KraController;
use App\Http\Controllers\Api\AttendanceController;
use Illuminate\Support\Facades\DB;
use App\Http\Controllers\LeaveRequestController;
use App\Http\Controllers\LeaveBalanceController;


/*
|--------------------------------------------------------------------------
| API Routes
|--------------------------------------------------------------------------
|
| Here is where you can register API routes for your application. These
| routes are loaded by the RouteServiceProvider within a group which
| is assigned the "api" middleware group. Enjoy building your API!
|
*/



Route::post('/login', [AuthController::class, 'login']);
Route::middleware('auth:sanctum')->post('/logout', [AuthController::class, 'logout']);


Route::get('/users', [UserController::class, 'index']);
Route::delete('/users/{id}', [UserController::class, 'destroy']);
Route::post('/employees', [EmployeeController::class, 'store']);
Route::post('/register', [AuthController::class, 'register']);

Route::middleware('auth:sanctum')->get('/user', function (Request $request) {
    return $request->user();
});


Route::put('/users/{id}', [AuthController::class, 'update']);

Route::post('/leave-types', [LeaveTypeController::class, 'store']);
Route::get('/leave-types', [LeaveTypeController::class, 'index']);
Route::delete('/leave-types/{id}', [LeaveTypeController::class, 'destroy']);
Route::put('/leave-types/{id}', [LeaveTypeController::class, 'update']);
Route::post('/departments', [DepartmentController::class, 'store']);
Route::get('/departments', [DepartmentController::class, 'index']);
Route::delete('/departments/{id}', [DepartmentController::class, 'destroy']);
Route::post('/daily-reports', [DailyReportController::class, 'store']);
Route::get('/daily-reports', [DailyReportController::class, 'index']);

Route::middleware('auth:sanctum')->get('/tasks', [TaskController::class, 'index']);




Route::middleware('auth:sanctum')->group(function () {
    Route::get('/tasks', [TaskController::class, 'index']);
    Route::post('/tasks', [TaskController::class, 'store']);
    Route::put('/tasks/{id}', [TaskController::class, 'update']);   
    Route::delete('/tasks/{id}', [TaskController::class, 'destroy']);
});

Route::get('/employee-reports', [TaskReportController::class, 'index']);
Route::post('/employee-reports', [TaskReportController::class, 'store']);

Route::post('/kras', [KraController::class, 'store']);

Route::get('/departments/{id}/kras', [DepartmentController::class, 'getKras']);

Route::get('/kras/{department_id}', [KRAController::class, 'getByDepartment']);
Route::put('/users/{id}/assign-kra', [UserController::class, 'assignKRA']);
Route::post('/assign-kra', [UserController::class, 'assignKRA']);

Route::get('/kras', [KRAController::class, 'index']);
// routes/api.php
Route::get('/attendance/status-counts', [AttendanceController::class, 'statusCounts']);

// routes/api.php
Route::middleware('auth:sanctum')->post('/attendance/store', [AttendanceController::class, 'store']);

Route::post('/attendance/update', [AttendanceController::class, 'update']);

Route::get('/attendance', [AttendanceController::class, 'index']); // <-- if you're using GET

Route::post('/attendance/monthly', [AttendanceController::class, 'getMonthlyAttendance'])->middleware('auth:sanctum');
Route::post('/attendance/update', [AttendanceController::class, 'update']);

Route::get('/attendance/monthly/{name}', [AttendanceController::class, 'getMonthlyAttendance']);

// routes/api.php
Route::get('/user-salary/{id}', [UserController::class, 'getSalary']);

Route::get('/user-salary-by-name/{name}', function ($name) {
    $user = DB::table('users')->where('name', $name)->first();

    if (!$user) {
        return response()->json(['message' => 'User not found'], 404);
    }

    return response()->json(['salary' => $user->keyresponsibility]);
});


Route::get('/leave-requests', [LeaveRequestController::class, 'index']);

Route::patch('/leave-requests/{leaveRequest}/status', [LeaveRequestController::class, 'updateStatus']);

Route::middleware('auth:sanctum')->get('/leave-balance', [LeaveBalanceController::class, 'show']);



Route::middleware('auth:sanctum')->group(function () {
    // ✅ secure leave request submission
    Route::post('/leave-request', [LeaveRequestController::class, 'store']);

    // ✅ secure notifyAdmin
    Route::post('/leave-notify', [LeaveRequestController::class, 'notifyAdmin']);
});

Route::post('/attendance/today', [AttendanceController::class, 'getTodayAttendance']);

Route::post('/upload-document', [KRAController::class, 'uploadDocuments']);

Route::middleware('auth:sanctum')->post('/change-password', [UserController::class, 'changePassword']);

Route::middleware('auth:sanctum')->get('/profile', function (Request $request) {
    return response()->json(['user' => $request->user()]);
});

Route::post('/send-registration-email', [MailController::class, 'sendRegistrationEmail']);




